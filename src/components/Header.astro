---
import CollapseButton from "./CollapseButton.astro";
import ExpandButton from "./ExpandButton.astro";
import SearchLink from "./SearchLink.astro";
import CollectionLink from "./CollectionLink.astro";

const collections = [
  ["Fiction", "fiction"],
  ["Essays", "essays"],
  ["Technical", "technical"],
  ["Logs", "logs"],
  ["TIL", "til"],
  ["Miscellaneous", "misc"],
  ["Gallery", "gallery"],
];
---

<script>
  // Show or hide expanded state
  const collectionElements = document.querySelectorAll("#collection");
  const searchButton = document.querySelector("#searchButton");
  const expandButton = document.querySelector("#expandButton");
  const collapseButton = document.querySelector("#collapseButton");

  searchButton?.classList.remove("hidden");
  expandButton?.classList.remove("hidden");

  expandButton?.addEventListener("click", () => {
    collectionElements.forEach((el) => {
      el.classList.remove("hidden");
    });
    console.log(`collapseButton: ${collapseButton}`);
    expandButton.classList.add("hidden");
    collapseButton?.classList.remove("hidden");
  });

  collapseButton?.addEventListener("click", () => {
    collectionElements.forEach((el) => {
      el.classList.add("hidden");
    });
    expandButton?.classList.remove("hidden");
    collapseButton.classList.add("hidden");
  });
</script>

<script>
  // Scroll to anchor links, taking into account header
  const header = document.querySelector("#header") as HTMLElement;
  const headerHeight = header?.offsetHeight ?? 0;
  const anchorLinks = document.querySelectorAll("a[href^='#']");

  for (const anchorLink of anchorLinks) {
    anchorLink.addEventListener("click", function (event) {
      if (
        window.getComputedStyle(header).getPropertyValue("position") !==
        "sticky"
      ) {
        return;
      }

      event.preventDefault();

      const targetId = anchorLink.getAttribute("href") ?? "";
      const targetPosition = (document.querySelector(targetId) as HTMLElement)
        ?.offsetTop;

      window.scrollTo({
        top: targetPosition - headerHeight,
        behavior: "smooth",
      });
      window.history.pushState(null, "", targetId);
    });
  }

  function scrollToAnchor() {
    if (
      window.getComputedStyle(header).getPropertyValue("position") !== "sticky"
    ) {
      return;
    }

    var targetId = location.hash.slice(1);
    if (targetId) {
      var targetElement = document.getElementById(targetId);
      if (targetElement) {
        var targetOffset = targetElement.offsetTop - headerHeight;
        window.scrollTo({
          top: targetOffset,
          behavior: "smooth",
        });
      }
    }
  }

  window.addEventListener("hashchange", scrollToAnchor);
  window.addEventListener("load", scrollToAnchor);
</script>

<nav id="header" class="flex flex-col md:sticky top-0 inset-x-0 z-0">
  <div
    class="px-4 lg:px-12 bg-black h-24 w-full flex items-center justify-between"
  >
    <a
      class="text-white dark:text-rwb-text-dark text-3xl lg:text-4xl no-underline hover:underline"
      href="/index.html"
    >
      rwblickhan.org
    </a>
    <div class="flex flex-row items-center">
      <SearchLink id="searchButton" />
      <ExpandButton id="expandButton" />
      <CollapseButton id="collapseButton" />
    </div>
  </div>
  {
    collections.map(([title, slug]) => (
      <CollectionLink id="collection" slug={slug} title={title} />
    ))
  }
  <noscript>
    <div class="p-4 bg-black flex flex-row items-center justify-around">
      {
        collections.map(([title, slug]) => (
          <a
            class="text-white dark:text-rwb-text-dark text-2xl no-underline hover:underline"
            href={`/${slug}`}
          >
            {title}
          </a>
        ))
      }
    </div>
  </noscript>
</nav>
